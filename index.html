<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Giphy API</title>
  <link rel="stylesheet" href="./assets/css/reset.css">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!-- link jquery -->
  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Exo+2:400,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="icon" href="./assets/images/search.ico">
</head>

<body class="bg">
  <div class="container">
    <h2 id="title" class="jumbotron text-center">Giphy Search</h2>
    <hr class="line">
    <!-- Buttons will Get Dumped Here -->
    <div id="buttons-view"></div>

    <div class="row mt-3">
      <div class="col-sm-12 ml-3">
        <form id="search-form">
          <input type="text" id="giphy-input" placeholder="Add Giphy">
          <!-- Button triggers new giphy to be added -->
          <button id="add-giphy" class="btn btn-success" type="submit" value="submit">Submit</button>
      </div>
      </form>
    </div>

    <div class="row">
      <div id="content" class="col-sm-12 mt-5 mb-5 text-center"></div>
    </div>
  </div>

  <script type="text/javascript">

    // array to hold giphy buttons
    var giphyArr = ["Pokemon", "Spongebob", "LOL", "Wow", "Roger That"];
    var saveOption = [];

    var count = 4;

    // get items from localstorage
    function getSavedOptions() {

      // get items from giphyArr and saveOption from local storage
      var getSavedOptions = localStorage.getItem('giphy');
      console.log(`Retrieved saved options from localstorage: ${getSavedOptions}`);
      saveOption.push(getSavedOptions);
      console.log(`getSavedOptions() Saved options in localstorage: ${saveOption}`);
    }

    // Function for dumping the JSON content for each button into the div
    function displayGiphy() {
      $('#content').empty();
      $('#title').text('Loading Gifs...');

      // when user presses a giphy button, search and display giphy
      event.preventDefault();
      var searchQuery = $(this).attr('data-name');
      console.log(`Search Query: ${searchQuery}`);

      var apiKey = 'FYvzSNBBiaOqf3rAD8ALeaoV0S69Qi29';
      var apiRoute = `https://api.giphy.com/v1/gifs/search?api_key=${apiKey}&q=${searchQuery}&limit=30&offset=0&rating=G&lang=en`;

      // async get method; call giphy api
      $.get({
        url: apiRoute
      }).done(function (response) {
        var currentRow;

        if (response.data.length === 0) {
          $('#title').text('No Gifs Found :(');
        } else {
          // for all gifs, append 3 images to a row
          for (var i = 0; i < response.data.length; i++) {
            if (i % 3 == 0) {
              currentRow = $("<div>");
              currentRow.addClass("row");
              $("#content").append(currentRow);
            }
            var div = $("<div>");
            div.addClass("col-sm-4");
            var tempImg = $("<img>");
            tempImg.addClass('gif m-2 border');
            tempImg.attr("src", response.data[i].images.fixed_width_still.url);
            tempImg.attr('data-still', response.data[i].images.fixed_width_still.url);
            tempImg.attr('data-animate', response.data[i].images.fixed_width.url);
            tempImg.attr('data-state', 'still');
            div.append(tempImg);
            $(currentRow).append(div);
          }

          $('#title').text('Click Gifs to Animate!');

          // if gif is clicked, toggle between animate and still gifs
          $(".gif").on("click", function () {
            console.log('clicked img');
            var state = $(this).attr('data-state');
            console.log(state);

            if (state === 'still') {
              var animate = $(this).attr('data-animate');
              $(this).attr('src', animate);
              var ani = $(this).attr('data-state', 'animate');
            } else if (state === 'animate') {
              var still = $(this).attr('data-still');
              $(this).attr('src', still);
              $(this).attr('data-state', 'still');
            }
          });
        }
      }); // end done function
    }; // end displayGiphy

    // Function for displaying button data
    function renderButtons() {

      // Deleting the buttons prior to adding new giphyArr
      $("#buttons-view").empty();

      // Looping through the array of giphyArr
      for (var i = 0; i < giphyArr.length; i++) {

        // Then dynamicaly generating buttons for each giphy in the array
        var createButton = $("<button>");
        // Adding a class of giphy to our button
        createButton.addClass("giphy btn btn-danger");
        // Adding a data-attribute
        createButton.attr("data-name", giphyArr[i]);
        // Providing the initial button text
        createButton.text(giphyArr[i]);
        // Adding the button to the buttons-view div
        $("#buttons-view").append(createButton);
      }
    };

    // This function handles events where one button is clicked
    $("#add-giphy").on("click", function (event) {
      event.preventDefault();
      console.log(`localstorage before: ${saveOption}`);

      // clear out localStorage
      localStorage.clear();
      console.log('cleared out localstorage');
      // get user input
      var userInput = $("#giphy-input").val().trim();

      // prevent user from adding blank or same buttons
      if (userInput === '') {
        $('#title').text('Nothing to add because it\'s blank!');
      } else if (giphyArr.includes(userInput) || saveOption.includes(userInput) || saveOption === 0) {
        console.log(`Is user input in save option: ${saveOption.includes(userInput)}`);
        $('#title').text(`${userInput} already exists!`);
        console.log('Button already exists');
      } else {
        // The giphy from the textbox is then added to our array
        saveOption.push(userInput);
        giphyArr.push(userInput);
        $('#title').text(`${userInput} has been added!`);

        // local storage
        localStorage.setItem('giphy', JSON.stringify(saveOption));
        console.log(`added to localstorage: ${saveOption}`);
        // NEED TO RETRIVE THIS WHEN USER OPENS PAGE OR REFRESH
        // WHEN BUTTON IS ADDED MAKE SURE IT CLEARS THE LOCALSTORAGE AND ADD IT BACK TO THE DOM
        // localStorage.getItem('giphy')
      }

      // Calling renderButtons which handles the processing of our giphy array
      renderButtons();
      // clear input field
      $('#giphy-input').val('');
    }); // end add giphy on click

    // Generic function for displaying the giphy images
    $(document).on("click", ".giphy", displayGiphy);

    // Calling the renderButtons function to display the intial buttons
    getSavedOptions();
    // console.log(`Getting items from localstorage: ${saveOption}`);
    renderButtons();

// TODO:
// add to localstorage
// when user loads the page, add current items from array to local storage
// get items out of local storage and render those items as buttons to dom
// when user creates a new button, add item to localstorage and render those items as buttons to dom
// option to add or remove gif buttons


// add to firebase
// make clear button
// option to add additional gifs while keeping current gifs

  </script>
</body>

</html>