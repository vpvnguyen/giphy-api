<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Giphy API</title>
  <link rel="stylesheet" href="./assets/css/reset.css">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!-- link jquery -->
  <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Exo+2:400,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="icon" href="./assets/images/search.ico">
</head>

<body class="bg">
  <div class="container">
    <h2 id="title" class="jumbotron text-center">Gif Searcher! Start by clicking on a button or add your own!</h2>
    <hr class="line">
    <!-- display buttons -->
    <div id="buttons-view"></div>

    <div class="row mt-3">
      <div class="col-sm-12 ml-3">
        <form id="search-form">
          <input type="text" id="giphy-input" placeholder="Type something here">
          <button id="add-giphy" class="btn btn-primary" type="submit" value="submit">Add New Button</button>
          <button id="reset-button" class="btn btn-warning" type="submit" value="submit">Reset Buttons</button>
      </div>
      </form>
    </div>

    <div class="row">
      <!-- display giphys -->
      <div id="content" class="col-sm-12 mt-5 mb-5 text-center"></div>
    </div>
  </div>

  <script type="text/javascript">

    // default array to hold giphy buttons
    var giphyArr = ["Pokemon", "Spongebob", "LOL", "Wow", "Mhmm"];

    // when page loads, get and parse items from local storage
    var storedArray = JSON.parse(localStorage.getItem("giphyArr"));

    // get items from localstorage
    function getSavedOptions() {

      // get and parse items from localstorage
      var storedArray = JSON.parse(localStorage.getItem("giphyArr"));

      // if localstorage is empty, push default options into array
      if (storedArray === null) {
        localStorage.setItem("giphyArr", JSON.stringify(giphyArr));
      } else {
        console.log(`getSavedOptions(): got items from storedArray ${storedArray}`);
      }
      console.log(`storedArray: ${storedArray}`);
    };

    // display gifs when button is clicked
    function displayGiphy() {
      $('#content').empty();
      $('#title').text('Loading Gifs...');

      // when user presses a giphy button, search and display giphy
      event.preventDefault();
      var searchQuery = $(this).attr('data-name');
      console.log(`Search Query: ${searchQuery}`);

      var apiKey = 'FYvzSNBBiaOqf3rAD8ALeaoV0S69Qi29';
      var apiRoute = `https://api.giphy.com/v1/gifs/search?api_key=${apiKey}&q=${searchQuery}&limit=30&offset=0&rating=G&lang=en`;

      // async get method; call giphy api
      $.get({
        url: apiRoute
      }).done(function(response) {

        // if no reponse, let user know nothing was found
        if (response.data.length === 0) {
          $('#title').text('No Gifs Found :(');
        } else {

          // if response, loop through array of gifs and create rows to contain gifs
          for (var i = 0; i < response.data.length; i++) {
            if (i % 3 == 0) {
              var createRow = $("<div>");
              createRow.addClass("row");
              $("#content").append(createRow);
            }
            var div = $("<div>");
            div.addClass("col-sm-4");
            var tempImg = $("<img>");
            tempImg.addClass('gif m-2 border');
            tempImg.attr("src", response.data[i].images.fixed_width_still.url);
            tempImg.attr('data-still', response.data[i].images.fixed_width_still.url);
            tempImg.attr('data-animate', response.data[i].images.fixed_width.url);
            tempImg.attr('data-state', 'still');
            div.append(tempImg);
            $(createRow).append(div);
          }

          // let user know that gifs can be animated by clicking on them; when gif is clicked, toggle between still and animated sources
          $('#title').text('Click Gifs to Animate!');
          $(".gif").on("click", function () {
            var state = $(this).attr('data-state');
            console.log('clicked img');
            console.log(state);

            if (state === 'still') {
              var animate = $(this).attr('data-animate');
              $(this).attr('src', animate);
              var ani = $(this).attr('data-state', 'animate');
            } else if (state === 'animate') {
              var still = $(this).attr('data-still');
              $(this).attr('src', still);
              $(this).attr('data-state', 'still');
            }
          });
        }

        // if response failed, let user know
      }).fail(function(response){
        $('#title').text('Sorry, unable to search for that :(');
      });
    };

    // dynamically create and display buttons from localstorage
    function displayButtons() {
      $("#buttons-view").empty();

      // get, parse, loop, and display items in local storage as buttons
      var storedArray = JSON.parse(localStorage.getItem("giphyArr"));

      for (var i = 0; i < storedArray.length; i++) {
        var createButton = $("<button>");
        createButton.addClass("giphy btn btn-danger");
        createButton.attr("data-name", storedArray[i]);
        createButton.text(storedArray[i]);
        $("#buttons-view").append(createButton);
      }
    };

    // when user adds a new giphy button
    $("#add-giphy").on("click", function (event) {
      event.preventDefault();
      var storedArray = JSON.parse(localStorage.getItem("giphyArr"));

      // get user input
      var userInput = $("#giphy-input").val().trim();

      // prevent user from adding blank or same string
      if (userInput === '') {
        $('#title').text('Nothing to add! Type something in!');
      } else if (storedArray.includes(userInput)) {
        $('#title').text(`${userInput} already exists!`);
        console.log('Button already exists');
      } else {

        // push userInput into array and save to localstorage
        storedArray.push(userInput);
        localStorage.setItem("giphyArr", JSON.stringify(storedArray));
        console.log(`localstorage setItem: ${storedArray}`);

        // let user know that a button has been added
        $('#title').text(`${userInput} has been added!`);
      }

      // display buttons and clear input field
      displayButtons();
      $('#giphy-input').val('');
    });

    // when user presses reset, clear out localstorage and show default items
    $('#reset-button').on('click', function() {
      localStorage.clear();
      getSavedOptions();
    });

    // Generic function for displaying the giphy images
    $(document).on("click", ".giphy", displayGiphy);

    // when page loads, check localstorage for saved items and display them
    getSavedOptions();
    displayButtons();
  </script>
</body>
</html>